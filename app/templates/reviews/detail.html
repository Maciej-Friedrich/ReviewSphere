{% extends "base.html" %}

{% block content %}
  <div class="card mb-4">
    <div class="card-body d-flex flex-wrap align-items-start">
      <div class="flex-grow-1">
        <h3>{{ review.title }}</h3>
        {% if review.image_path %}
          <img src="{{ url_for('static', filename=review.image_path) }}" alt="Obrazek recenzji" class="float-end ms-3 mb-3" style="max-width: 300px;">
        {% endif %}
        <p>{{ review.content }}</p>

        <p><strong>Ocena recenzenta:</strong> {{ average_rating }}/5</p>

        {% if community_count > 0 %}
          <p><strong>Ocena społeczności:</strong> {{ community_rating }}/5 ({{ community_count }} ocen)</p>
        {% else %}
          <p><strong>Ocena społeczności:</strong> Brak ocen</p>
        {% endif %}

        <p class="text-muted">Dodano: {{ review.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
      </div>
    </div>
  </div>

  {% if current_user.is_authenticated %}
    <form method="POST" action="{{ url_for('votes.cast_vote', review_id=review.id) }}" class="mb-4">
      <label><strong>Twoja ocena tej recenzji:</strong></label>
      <div class="star-rating mb-2">
        {% for i in range(5, 0, -1) %}
          <input type="radio" name="community_rating" id="rating-{{ i }}" value="{{ i }}">
          <label for="rating-{{ i }}" title="{{ i }} gwiazdek">&#9733;</label>
        {% endfor %}
      </div>
      <button class="btn btn-sm btn-outline-primary" type="submit">Oceń</button>
    </form>
  {% endif %}

  <h4>Komentarze</h4>
  {% for comment in comments %}
    <div class="card mb-2">
      <div class="card-body">
        <p>{{ comment.content }}</p>
        <p class="text-muted">Dodano: {{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}, przez użytkownika {{ comment.user.username }}</p>
      </div>
    </div>
  {% else %}
    <p>Brak komentarzy.</p>
  {% endfor %}

  <hr>
  <h5>Dodaj komentarz</h5>
  <form method="POST">
    {{ form.hidden_tag() }}
    <div class="mb-3">
      {{ form.content.label(class="form-label") }}
      {{ form.content(class="form-control", rows=3) }}
    </div>
    <button type="submit" class="btn btn-primary">{{ form.submit.label.text }}</button>
  </form>

  {% if current_user.is_authenticated and (review.user_id == current_user.id or current_user.role in ['admin', 'moderator']) %}
    <div class="mt-3">
      <a href="{{ url_for('reviews.edit_review', id=review.id) }}" class="btn btn-sm btn-warning me-2">Edytuj</a>
      <form method="POST" action="{{ url_for('reviews.delete_review', id=review.id) }}" style="display: inline;" onsubmit="return confirm('Czy na pewno chcesz usunąć tę recenzję?');">
        <button type="submit" class="btn btn-sm btn-danger">Usuń</button>
      </form>
    </div>
  {% endif %}
  
  {% if current_user.is_authenticated and (comment.user_id == current_user.id or current_user.role in ['admin', 'moderator']) %}
  <a href="{{ url_for('comments.edit_comment', id=comment.id) }}" class="btn btn-sm btn-outline-warning me-1">Edytuj</a>
  <form method="POST" action="{{ url_for('comments.delete_comment', id=comment.id) }}" style="display:inline;" onsubmit="return confirm('Czy na pewno chcesz usunąć ten komentarz?');">
    <button type="submit" class="btn btn-sm btn-outline-danger">Usuń</button>
  </form>
{% endif %}

  <style>
    .star-rating {
      direction: rtl;
      font-size: 1.6rem;
      unicode-bidi: bidi-override;
      display: inline-flex;
    }
    .star-rating input {
      display: none;
    }
    .star-rating label {
      color: #ccc;
      cursor: pointer;
      padding: 0 2px;
    }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: gold;
    }
  </style>
{% endblock %}
